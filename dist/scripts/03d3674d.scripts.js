"use strict";var serverAddress="https://ftn-13190.onmodulus.net",app=angular.module("geoLocationMessagingClientApp",["ngRoute"]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/posts.html",controller:"PostsListController"}).when("/newPost",{templateUrl:"views/newPost.html",controller:"NewPostController"}).otherwise({redirectTo:"/"})}]),app.service("locationService",function(){var a=null,b={enableHighAccuracy:!0,timeout:5e3,maximumAge:0};this.getLocation=function(c,d){function e(b){a=b.coords,console.log("Your current position is: ["+a.longitude+", "+a.latitude+"]"),console.log("More or less "+a.accuracy+" meters."),c(a)}function f(a){switch(a.code){case a.PERMISSION_DENIED:d.feedback="Using geolocation is disabled on your device.";break;case a.POSITION_UNAVAILABLE:d.feedback="Location information is unavailable.";break;case a.TIMEOUT:d.feedback="The request to get user location timed out.";break;case a.UNKNOWN_ERROR:d.feedback="An unknown error occurred."}d.$apply()}null===a?navigator.geolocation.getCurrentPosition(e,f,b):c(a)}}),app.service("dataService",["$http","locationService",function(a,b){this.getData=function(c,d){b.getLocation(function(b){a({method:"POST",url:serverAddress+"/posts",data:{longitude:b.longitude,latitude:b.latitude}}).success(function(a){c(a,d)}).error(function(){console.log("error")})},d)}}]),app.controller("PostsListController",["$scope","$interval","$q","dataService",function(a,b,c,d){function e(){angular.forEach(a.posts,function(a){var b="m";a.distance>1e3&&(a.distance/=1e3,b="km"),a.distance=Math.round(a.distance,1)+" "+b})}function f(){angular.forEach(a.posts,function(a){a.moment=moment(a.created_at).fromNow()})}a.posts=null,a.feedback="Loading... (Please allow using GPS location on your device)",a.onReload=function(){console.warn("reloading")},d.getData(function(c){a.posts=c,a.feedback="",e(),f(),b(f,6e4,0,!1)},a),a.getCloser=function(){console.log("fetching closer messages")},a.getFurther=function(){console.log("fetching more distant messages")}}]),app.controller("NewPostController",["$scope","$http","locationService",function(a,b,c){a.enabled=!1,a.feedback="Waiting for location data...",a.loc=null,c.getLocation(function(b){a.loc=b,a.enabled=!0,a.$$phase||a.$apply()},a),a.send=function(){a.feedback="Sending...",a.enabled=!1,b({method:"POST",url:serverAddress+"/posts/new",data:{message:a.message,longitude:a.loc.longitude,latitude:a.loc.latitude}}).success(function(){a.feedback="Message sent.",a.message=""})}}]);