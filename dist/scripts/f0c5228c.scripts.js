"use strict";var serverAddress="https://ftn-13190.onmodulus.net",urlquery="",geoLocationServiceAddress="https://maps.googleapis.com/maps/api/geocode/json?",POSTS_PER_PAGE=5,app=angular.module("geoLocationMessagingClientApp",["ngRoute","ngCookies","ui.map"]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/posts.html",controller:"PostsListController"}).when("/map",{templateUrl:"views/map.html",controller:"MapsController"}).when("/new",{templateUrl:"views/new.html",controller:"NewPostController"}).when("/settings",{templateUrl:"views/settings.html",controller:"SettingsController"}).otherwise({redirectTo:"/"})}]),app.controller("mainCtrl",["$scope","$rootScope","$location","$cookies","locationService",function(a,b,c,d,e){void 0===d.username&&(d.username="Anonymous"+Math.round(1e4*Math.random()),d.sampledata=!1),a.settings={username:d.username,sampleData:"true"===d.sampledata},a.changePostsPath=function(){urlquery=a.settings.sampleData===!0?"?sampleflag":""},a.changePostsPath(),a.address="",a.coords=null,e.getAddress(function(b,c){a.address="OK"===b.status?b.results[0].formatted_address+" (Accuracy: "+c.accuracy+"m)":"Couldn't locate you."}),b.$on("$routeChangeSuccess",function(){a.route=c.path()}),a.$on("LOAD_START",function(){a.loading=!0}),a.$on("LOAD_END",function(){a.loading=!1})}]),app.$inject=["$rootScope","$location"],app.service("locationService",["$http",function(a){var b=null,c={enableHighAccuracy:!0,timeout:3e4,maximumAge:0};this.getLocation=function(a,d){function e(c){b=c.coords,a(b)}function f(a){switch(a.code){case a.PERMISSION_DENIED:d.feedback="Using geolocation is disabled on your device.";break;case a.POSITION_UNAVAILABLE:d.feedback="Location information is unavailable.";break;case a.TIMEOUT:d.feedback="The request to get user location timed out.";break;case a.UNKNOWN_ERROR:d.feedback="An unknown error occurred."}d.$apply()}navigator.geolocation.getCurrentPosition(e,f,c)},this.getAddress=function(b){this.getLocation(function(c){a({method:"GET",url:geoLocationServiceAddress+"latlng="+c.latitude+","+c.longitude+"&sensor=true"}).success(function(a){b(a,c)}).error(function(){console.log("error")})},this)}}]),app.service("dataService",["$http","locationService",function(a,b){this.getData=function(c,d){b.getLocation(function(b){a({method:"POST",url:serverAddress+"/posts"+urlquery,data:{longitude:b.longitude,latitude:b.latitude,page:d.page}}).success(function(a){c(a,d)}).error(function(){d.$emit("ERROR","Error fetching data from server.")})},d)}}]),app.controller("PostsListController",["$scope","$interval","$q","dataService",function(a,b,c,d){function e(){a.$emit("LOAD_START"),d.getData(function(c){a.posts=c,a.feedback="",a.$emit("LOAD_END"),f(),g(),b(g,6e4,0,!1)},a)}function f(){angular.forEach(a.posts,function(a){a.distance<1e3?a.distance=Math.round(a.distance)+" m":(a.distance/=10,a.distance=Math.round(a.distance)/100+" km")})}function g(){angular.forEach(a.posts,function(a){a.moment=moment(a.created_at).fromNow()})}a.posts=[],a.page=1,a.feedback="Loading... (Please make sure GPS is enabled on your device)",a.onReload=function(){console.warn("reloading")},a.$on("ERROR",function(a){console.log(a)}),e(),a.getCloser=function(){a.page>1&&(a.page--,e()),console.log("Page: ",a.page)},a.getFurther=function(){a.posts.length===POSTS_PER_PAGE&&(a.page++,e()),console.log("Page: ",a.page),console.log(a.posts)}}]),app.controller("NewPostController",["$scope","$http","locationService",function(a,b,c){a.enabled=!1,a.feedback="Waiting for location data...",a.loc=null,a.message="",c.getLocation(function(b){a.loc=b,a.coords=b,a.enabled=!0,a.$$phase||a.$apply()},a),a.send=function(){return""===a.message?(a.feedback="Please enter message...",a.$$phase||a.$apply(),!1):(a.feedback="Sending...",a.enabled=!1,void b({method:"POST",url:serverAddress+"/posts/new",data:{message:a.message,longitude:a.loc.longitude,latitude:a.loc.latitude,device_id:a.settings.username}}).success(function(){a.feedback="Message sent.",a.message=""}))}}]),app.controller("SettingsController",["$scope","$cookies",function(a,b){a.$watch("settings.username",function(){b.username=a.settings.username}),a.$watch("settings.sampleData",function(){b.sampledata=a.settings.sampleData,a.changePostsPath()})}]),app.controller("MapsController",["$scope","$http","locationService",function(a,b,c){c.getLocation(function(b){if(void 0!==a.myMap){a.myMap.setOptions({center:new google.maps.LatLng(b.latitude,b.longitude),zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP});var c="custom/marker-blue.png";a.you=new google.maps.Marker({position:new google.maps.LatLng(b.latitude,b.longitude),map:a.myMap,title:"You are here!",animation:google.maps.Animation.DROP,icon:c}),google.maps.event.addListener(a.myMap,"idle",function(){var b={"long":a.myMap.getBounds().getNorthEast().lng(),lat:a.myMap.getBounds().getNorthEast().lat()},c={"long":a.myMap.getBounds().getSouthWest().lng(),lat:a.myMap.getBounds().getSouthWest().lat()},d={"long":c.long,lat:b.lat},e={"long":b.long,lat:c.lat};a.getPointsWithin(b,d,c,e)})}},a),a.getPointsWithin=function(c,d,e,f){b({method:"POST",url:serverAddress+"/posts/within"+urlquery,data:{points:[[[c.long,c.lat],[d.long,c.lat],[e.long,e.lat],[f.long,f.lat],[c.long,c.lat]]]}}).success(function(b){a.populateMap(b)}).error(function(){console.log("Couldn't  fetch data.")})},a.allMarkerKeys=[],a.populateMap=function(b){var c=[],d={gridSize:50,maxZoom:15};b.forEach(function(b){var d=new google.maps.LatLng(b.loc.coordinates[1],b.loc.coordinates[0]);if(-1===a.allMarkerKeys.indexOf(b._id)){var e=void 0!==b.device_id?"<br>by "+b.device_id:"",f=b.message.replace(/(?:\r\n|\r|\n)/g,"<br />"),g=new MarkerWithLabel({position:d,draggable:!1,map:a.myMap,labelContent:f+e,labelAnchor:new google.maps.Point(22,0),labelClass:"label"});c.push(g),a.allMarkerKeys.push(b._id)}});new MarkerClusterer(a.myMap,c,d)}}]),$(function(){$(document).on("mouseover",".distance",function(){var a=$(this);a.popover({trigger:"focus"}),a.popover("show")}),$(document).on("mouseout",".distance",function(a){var b=$(this);("ng-binding"===a.toElement.classList[0]||"row"===a.toElement.classList[0])&&b.popover("hide")}),$(document).on("mouseleave",".popover",function(){$(this).fadeOut(250)})});